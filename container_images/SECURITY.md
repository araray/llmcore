# LLMCore Sandbox Security

This document describes the security features and best practices for LLMCore sandbox container images.

## Threat Model

LLMCore sandbox images are designed to:
1. Execute untrusted code generated by AI agents
2. Isolate agent activities from the host system
3. Prevent data exfiltration and resource abuse
4. Provide audit trails for all operations

## Security Layers

### 1. Container Isolation

**Non-root User**
All images run as the `sandbox` user (UID 1000):
```dockerfile
USER sandbox
```

**Dropped Capabilities**
Recommended Docker run flags:
```bash
docker run \
  --cap-drop=ALL \
  --cap-add=CHOWN \
  --security-opt=no-new-privileges:true \
  llmcore-sandbox-python:1.0.0
```

**Read-only Root Filesystem**
```bash
docker run \
  --read-only \
  --tmpfs /tmp:size=100m \
  --tmpfs /home/sandbox/.cache:size=500m \
  llmcore-sandbox-python:1.0.0
```

### 2. Network Isolation

**RESTRICTED Mode (Default)**
Network access is completely blocked:
```bash
docker run --network=none llmcore-sandbox-python:1.0.0
```

**FULL Mode (Research/Websearch)**
Network access enabled but should be combined with:
- Egress filtering (firewall rules)
- DNS restrictions
- Rate limiting

### 3. Filesystem Restrictions

**Volume Mounting**
Only mount specific directories:
```bash
docker run \
  -v /path/to/input:/home/sandbox/input:ro \
  -v /path/to/output:/home/sandbox/output:rw \
  llmcore-sandbox-python:1.0.0
```

**Sensitive Paths**
Never mount:
- Docker socket (`/var/run/docker.sock`)
- Host system directories (`/etc`, `/var`)
- SSH keys or credentials

### 4. Resource Limits

**Memory and CPU**
```bash
docker run \
  --memory=1g \
  --memory-swap=1g \
  --cpus=2 \
  --pids-limit=100 \
  llmcore-sandbox-python:1.0.0
```

**Disk Space**
Use quota-enabled tmpfs:
```bash
docker run \
  --tmpfs /tmp:size=100m \
  llmcore-sandbox-python:1.0.0
```

### 5. Security Profiles

**AppArmor**
Create `/etc/apparmor.d/llmcore-sandbox`:
```
#include <tunables/global>

profile llmcore-sandbox flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  
  # Deny network except for FULL mode
  deny network,
  
  # Deny sensitive paths
  deny /etc/shadow r,
  deny /etc/passwd w,
  deny /proc/*/mem rw,
  
  # Allow work directory
  /home/sandbox/** rw,
}
```

Apply:
```bash
docker run \
  --security-opt apparmor=llmcore-sandbox \
  llmcore-sandbox-python:1.0.0
```

**seccomp**
Use a restrictive seccomp profile:
```bash
docker run \
  --security-opt seccomp=/path/to/seccomp.json \
  llmcore-sandbox-python:1.0.0
```

### 6. Image Hardening

**No SUID/SGID Binaries**
Removed during build:
```dockerfile
RUN find / -xdev -perm /6000 -type f -exec chmod a-s {} \;
```

**Minimal Packages**
Images include only essential packages. No:
- Compilers (except when needed)
- Network scanning tools
- Package managers (except pip/npm for dev images)

**Security Updates**
Base images are built with:
```dockerfile
RUN apt-get update && apt-get upgrade -y
```

## Best Practices

### Running Sandboxes

1. **Always use resource limits**
   ```python
   limits = ResourceLimits(
       memory_mb=1024,
       cpu_cores=2,
       timeout_seconds=300,
       max_processes=100
   )
   ```

2. **Use RESTRICTED mode by default**
   Only use FULL mode when network access is required.

3. **Mount volumes read-only when possible**
   ```bash
   docker run -v /data:/input:ro ...
   ```

4. **Set timeouts**
   Always configure execution timeouts to prevent runaway processes.

### Monitoring

**Audit Logging**
Enable Docker audit logging:
```bash
auditctl -w /var/lib/docker -k docker
```

**Container Events**
Monitor container lifecycle:
```bash
docker events --filter type=container
```

**Resource Usage**
Track resource consumption:
```bash
docker stats --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"
```

### Incident Response

1. **Kill running container immediately**
   ```bash
   docker kill <container_id>
   ```

2. **Preserve state for analysis**
   ```bash
   docker commit <container_id> incident-snapshot
   docker export <container_id> > incident.tar
   ```

3. **Review logs**
   ```bash
   docker logs <container_id>
   ```

## Security Checklist

- [ ] Running as non-root user
- [ ] Capabilities dropped
- [ ] Network isolation (RESTRICTED mode)
- [ ] Read-only filesystem where possible
- [ ] Resource limits configured
- [ ] AppArmor/seccomp profiles applied
- [ ] Volume mounts minimized
- [ ] Timeouts configured
- [ ] Logging enabled

## Reporting Vulnerabilities

If you discover a security vulnerability in LLMCore sandbox images, please report it to:
- Email: security@llmcore.example.com
- Do not create public GitHub issues for security vulnerabilities

## References

- [Docker Security Best Practices](https://docs.docker.com/develop/security-best-practices/)
- [CIS Docker Benchmark](https://www.cisecurity.org/benchmark/docker)
- [NIST Container Security Guide](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-190.pdf)
